<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.owl.kanban.dao.KanbanDao">

<!-- 	<select id="selectProjectMember" resultType="com.owl.member.dto" parameterType="int">
		SELECT * FROM projectlist where projectidx = #{projectidx}
	</select> -->
	
	<insert id="insertColumn" parameterType="com.owl.kanban.dto.Column">
		INSERT INTO owl.colname(colname, projectidx) VALUE(#{colname}, #{projectIdx})
		<selectKey keyProperty="colIdx" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<insert id="insertIssue" parameterType="com.owl.kanban.dto.Issue">
		INSERT INTO owl.ISSUE(creator, issuetitle, content, issueprogress, projectidx, duedate, prioritycode, assigned, labelidx, colidx) 
		VALUES(#{creator}, #{issueTitle}, #{content}, #{issueProgress}, #{projectIdx}
					, #{dueDate, jdbcType=DATE} , #{priorityCode, jdbcType=VARCHAR}, #{assigned, jdbcType=VARCHAR}
					, <choose>
					    <when test="labelIdx != 0"> #{labelIdx} </when>
					    <otherwise> null </otherwise>
					  </choose>
					 
					 , <choose> 
						<when test="colIdx != 0"> #{colIdx} </when>
					    <otherwise> null </otherwise>
					  </choose>
					)
		<selectKey keyProperty="issueIdx" resultType="int" order ="AFTER">
	   		select LAST_INSERT_ID()
	 	</selectKey>
	</insert>


	<insert id="insertIssueFile" >
		INSERT INTO owl.File(BELONGTO, WRITER, FILENAME, FILESIZE, FILEFROM)
		VALUES(#{belongTo}, #{writer}, #{fileName}, #{fileSize}, #{fileFrom})
	</insert>


	<insert id="insertLabel" parameterType="com.owl.project.dto.Label">
		INSERT INTO owl.label(projectidx, labelcolor, labelname) VALUE(#{projectIdx}, #{labelColor}, #{labelName})
			<selectKey keyProperty="labelIdx" resultType="int" order="AFTER">
				SELECT LAST_INSERT_ID()
			</selectKey>
	</insert>


	<select id="getLabelList" resultType="com.owl.project.dto.Label">
		select labelidx, labelname, labelcolor from label WHERE projectidx = #{projectIdx}
	</select>
	
	
	<select id="getLabelinfo" resultType="com.owl.project.dto.Label">
		select  labelname, labelcolor from label WHERE labelIdx = #{labelIdx}
	</select>
	
	
	<select id="getIssueList" resultType="com.owl.kanban.dto.ColumnList">
	SELECT I.PROJECTIDX, I.ISSUETITLE, I.ISSUEIDX, I.ASSIGNED , I.colidx , C.colname, L.LABELNAME, L.LABELCOLOR
	FROM ISSUE I JOIN colname C  ON I.colidx = C.colidx JOIN LABEL L ON I.LABELIDX = L.LABELIDX
	WHERE I.PROJECTIDX= #{projectIdx}
	</select>  
	
	<select id="getColumn" resultType="com.owl.kanban.dto.Column">
  		select colidx, colname from colname c where projectidx=#{projectIdx}
	</select>
	
	<select id="getIssuebyIssueIdx" resultType="com.owl.kanban.dto.ColumnList">
		SELECT I.PROJECTIDX, I.ISSUETITLE,  I.ISSUEIDX, I.ASSIGNED, L.LABELNAME, L.LABELCOLOR
		FROM ISSUE I LEFT JOIN LABEL L  ON I.LABELIDX = L.LABELIDX
		WHERE I.PROJECTIDX=#{param1} AND I.ISSUEIDX=#{param2}
	</select>
	
	
	<update id="updateColumn" parameterType="com.owl.kanban.dto.Column">
		UPDATE COLNAME SET COLNAME = #{colname} WHERE PROJECTIDX = #{projectIdx} AND COLIDX=#{colIdx}
	</update>
	
</mapper>